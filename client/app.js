/* Covera Client (HTML/CSS/JS only) — Fullstack mode
   - Data is stored in PostgreSQL (Supabase) via the backend API.
   - Session (logged user) is saved in localStorage.
   - Chatbot is offline (rule-based) BUT answers using the data fetched from DB.
*/
// ====== CONFIG ======
const API_BASE = "https://covera-server.onrender.com/api";// <-- change to your Render URL later
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
function escapeHtml(str){return (str??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");}
function toast(title,message){const t=$("#toast");t.innerHTML=`<div class="t">${escapeHtml(title)}</div><div class="m">${escapeHtml(message)}</div>`;t.classList.add("show");clearTimeout(toast._timer);toast._timer=setTimeout(()=>t.classList.remove("show"),2600);}
function routeTo(hash){location.hash=hash;}
function getSession(){try{return JSON.parse(localStorage.getItem("covera_session")||"null");}catch{return null;}}
function setSession(user){localStorage.setItem("covera_session",JSON.stringify(user));}
function logout(){localStorage.removeItem("covera_session");toast("Logged out","See you!");routeTo("#/login");refreshNav();}
async function apiFetch(path,{method="GET",body=null}={}){const s=getSession();const headers={"Content-Type":"application/json"};if(s?.role)headers["x-role"]=s.role;if(s?.id)headers["x-user-id"]=String(s.id);const res=await fetch(`${API_BASE}${path}`,{method,headers,body:body?JSON.stringify(body):null});const data=await res.json().catch(()=>({}));if(!res.ok)throw new Error(data?.error?String(data.error):"REQUEST_FAILED");return data;}
function setActiveNav(){const hash=location.hash||"#/";$$("#nav a").forEach(a=>{const href=a.getAttribute("href");a.classList.toggle("active",href===hash);});}
function refreshNav(){$("#year").textContent=new Date().getFullYear();const s=getSession();$("#loginLink").style.display=s?"none":"inline-flex";$("#logoutBtn").style.display=s?"inline-flex":"none";$$("[data-auth='true']").forEach(el=>{el.style.display=s?"inline-flex":"none";});$$("[data-admin='true']").forEach(el=>{el.style.display=(s&&s.role==="ADMIN")?"inline-flex":"none";});setActiveNav();}
$("#logoutBtn").addEventListener("click",logout);refreshNav();
window.addEventListener("hashchange",render);window.addEventListener("load",render);
function render(){refreshNav();const hash=location.hash||"#/";const app=$("#app");const routes={"#/":HomePage,"#/login":LoginPage,"#/register":RegisterPage,"#/insurance":InsurancePage,"#/laws":LawsPage,"#/faq":FAQPage,"#/submit":SubmitRequestPage,"#/my-requests":MyRequestsPage,"#/chatbot":ChatbotPage,"#/admin":AdminPage};const page=routes[hash]||NotFoundPage;app.innerHTML=page();afterRender(hash);setActiveNav();}
function afterRender(hash){if(hash==="#/login")wireLogin();if(hash==="#/register")wireRegister();if(hash==="#/insurance")wireInsurance();if(hash==="#/laws")wireLaws();if(hash==="#/faq")wireFaq();if(hash==="#/submit")wireSubmit();if(hash==="#/my-requests")wireMyRequests();if(hash==="#/chatbot")wireChatbot();if(hash==="#/admin")wireAdmin();}
function HomePage(){const s=getSession();return `<section class="grid two"><div class="card"><div class="h1">Welcome to Covera</div><p class="p">Fullstack website: Frontend (HTML/CSS/JS) + Backend API + PostgreSQL (Supabase).</p><hr class="sep"/><div class="row">${s?`<span class="badge">Hello, ${escapeHtml(s.name)}</span><span class="badge">${s.role==="ADMIN"?"Administrator":"User"}</span>`:`<span class="badge">Guest mode</span><span class="badge">Login to submit requests</span>`}</div><hr class="sep"/><div class="small">Tip: If the API is not running, pages will show an error.</div></div><div class="card"><div class="h1" style="font-size:20px;">Quick links</div><hr class="sep"/><div class="row"><a class="btn" href="#/insurance">Browse Insurance</a><a class="btn btn-ghost" href="#/submit">Submit Request</a><a class="btn btn-ghost" href="#/chatbot">Chatbot</a></div><hr class="sep"/><div class="small">API Base: <span class="code">${escapeHtml(API_BASE)}</span></div></div></section>`;}
function LoginPage(){return `<section class="card" style="max-width:520px;margin:0 auto;"><div class="h1">Login</div><p class="p">Access your requests and submit new ones.</p><hr class="sep"/><form id="loginForm" class="grid"><div><div class="label">Email</div><input class="input" name="email" autocomplete="email" placeholder="you@example.com" required /></div><div><div class="label">Password</div><input class="input" name="password" type="password" autocomplete="current-password" placeholder="••••••" required /></div><button class="btn" type="submit">Login</button></form><p class="small" style="margin-top:10px;">No account? <a href="#/register"><u>Register</u></a></p></section>`;}
function RegisterPage(){return `<section class="card" style="max-width:560px;margin:0 auto;"><div class="h1">Register</div><p class="p">Create a user account (stored in PostgreSQL).</p><hr class="sep"/><form id="registerForm" class="grid"><div><div class="label">Full name</div><input class="input" name="name" placeholder="Your name" required /></div><div><div class="label">Email</div><input class="input" name="email" autocomplete="email" placeholder="you@example.com" required /></div><div><div class="label">Password</div><input class="input" name="password" type="password" minlength="6" placeholder="Min 6 characters" required /></div><button class="btn" type="submit">Create account</button></form><p class="small" style="margin-top:10px;">Have an account? <a href="#/login"><u>Login</u></a></p></section>`;}
function InsurancePage(){return `<section class="card"><div class="h1">Insurance Information</div><p class="p">Search and filter insurance products.</p><hr class="sep"/><div class="grid two"><div><div class="label">Search (Arabic/English)</div><input id="insQ" class="input" placeholder="e.g., شامل / comprehensive" /></div><div><div class="label">Category</div><select id="insCat" class="select"><option value="">All</option></select></div></div><div class="row" style="margin-top:10px;"><button class="btn" id="insSearchBtn">Apply</button><button class="btn btn-ghost" id="insResetBtn">Reset</button></div><div id="insList" class="grid" style="margin-top:14px;"></div></section>`;}
function LawsPage(){return `<section class="card"><div class="h1">Laws & Regulations</div><p class="p">Key legal compliance information.</p><hr class="sep"/><div class="row"><input id="lawQ" class="input" placeholder="Search laws... / ابحث..." style="max-width:420px;" /><button class="btn" id="lawSearchBtn">Search</button><button class="btn btn-ghost" id="lawResetBtn">Reset</button></div><div id="lawList" class="grid" style="margin-top:14px;"></div></section>`;}
function FAQPage(){return `<section class="card"><div class="h1">FAQ</div><p class="p">Common questions and answers.</p><hr class="sep"/><div class="row"><input id="faqQ" class="input" placeholder="Search FAQ... / ابحث..." style="max-width:420px;" /><button class="btn" id="faqSearchBtn">Search</button><button class="btn btn-ghost" id="faqResetBtn">Reset</button></div><div id="faqList" class="grid" style="margin-top:14px;"></div></section>`;}
function SubmitRequestPage(){const s=getSession();if(!s){return `<section class="card"><div class="h1">Submit Request</div><p class="p">You need to login first.</p><hr class="sep"/><a class="btn" href="#/login">Go to Login</a></section>`;}return `<section class="card"><div class="h1">Submit Insurance Request</div><p class="p">Request will be saved in PostgreSQL.</p><hr class="sep"/><form id="reqForm" class="grid two"><div><div class="label">Choose insurance (optional)</div><select class="select" name="insuranceId" id="reqInsurance"><option value="">—</option></select></div><div><div class="label">Phone</div><input class="input" name="phone" placeholder="+970..." required /></div><div><div class="label">Full name</div><input class="input" name="fullName" placeholder="Your full name" required /></div><div><div class="label">Car model</div><input class="input" name="carModel" placeholder="e.g., Toyota Corolla" required /></div><div><div class="label">Car year</div><input class="input" name="carYear" type="number" min="1950" max="2100" value="2020" required /></div><div><div class="label">Notes (optional)</div><input class="input" name="notes" placeholder="Any extra info..." /></div><div style="grid-column:1/-1;"><button class="btn" type="submit">Submit</button></div></form></section>`;}
function MyRequestsPage(){const s=getSession();if(!s){return `<section class="card"><div class="h1">My Requests</div><p class="p">Login to view your requests.</p><hr class="sep"/><a class="btn" href="#/login">Go to Login</a></section>`;}return `<section class="card"><div class="h1">My Requests</div><p class="p">Your submitted requests (from PostgreSQL).</p><hr class="sep"/><div id="myReqList"></div></section>`;}
function ChatbotPage(){return `<section class="card"><div class="h1">AI Chatbot (Offline logic)</div><p class="p">Answers using data fetched from DB (Insurance/Laws/FAQ/Requests) — Arabic or English.</p><hr class="sep"/><div class="card" style="background:rgba(255,255,255,.04);"><div id="chatLog" style="height:260px;overflow:auto;white-space:pre-wrap;"></div></div><div class="row" style="margin-top:10px;"><input id="chatMsg" class="input" placeholder="اكتب سؤالك... / Type your question..." style="flex:1;min-width:220px;" /><button id="chatSend" class="btn">Send</button></div></section>`;}
function AdminPage(){const s=getSession();if(!s){return `<section class="card"><div class="h1">Admin</div><p class="p">Login as admin to manage content.</p><hr class="sep"/><a class="btn" href="#/login">Go to Login</a></section>`;}if(s.role!=="ADMIN"){return `<section class="card"><div class="h1">Admin</div><p class="p">You don't have admin access.</p></section>`;}return `<section class="grid two"><div class="card"><div class="h1">Admin • Manage Content</div><p class="p">Add insurance, laws, and FAQ entries (stored in DB).</p><hr class="sep"/><div class="h1" style="font-size:18px;">Add Insurance</div><form id="addIns" class="grid"><input class="input" name="title_ar" placeholder="Title (Arabic) - عنوان عربي" /><input class="input" name="title_en" placeholder="Title (English) - English title" /><input class="input" name="category_ar" placeholder="Category (Arabic)" /><input class="input" name="category_en" placeholder="Category (English)" /><input class="input" name="price_from" type="number" min="0" step="1" placeholder="Price from" required /><textarea class="textarea" name="description_ar" placeholder="Description (Arabic)"></textarea><textarea class="textarea" name="description_en" placeholder="Description (English)"></textarea><button class="btn" type="submit">Add</button></form><hr class="sep"/><div class="h1" style="font-size:18px;">Add Law</div><form id="addLaw" class="grid"><input class="input" name="title_ar" placeholder="Title (Arabic)" /><input class="input" name="title_en" placeholder="Title (English)" /><textarea class="textarea" name="description_ar" placeholder="Description (Arabic)"></textarea><textarea class="textarea" name="description_en" placeholder="Description (English)"></textarea><button class="btn" type="submit">Add</button></form><hr class="sep"/><div class="h1" style="font-size:18px;">Add FAQ</div><form id="addFaq" class="grid"><input class="input" name="question_ar" placeholder="Question (Arabic)" /><input class="input" name="question_en" placeholder="Question (English)" /><textarea class="textarea" name="answer_ar" placeholder="Answer (Arabic)"></textarea><textarea class="textarea" name="answer_en" placeholder="Answer (English)"></textarea><button class="btn" type="submit">Add</button></form></div><div class="card"><div class="h1">Users</div><p class="p">Promote user to Admin or demote to User.</p><hr class="sep"/><div id="adminUsersList"></div><hr class="sep"/><div class="h1">Requests</div><p class="p">Review and change request status.</p><hr class="sep"/><div id="adminReqList"></div><hr class="sep"/><div class="small">Demo security: Admin check uses x-role header from session.</div></div></section>`;}
function NotFoundPage(){return `<section class="card"><div class="h1">Not found</div><p class="p">This page doesn't exist.</p><hr class="sep"/><a class="btn" href="#/">Back home</a></section>`;}
function normalizeText(s){return (s||"").toString().toLowerCase().replace(/[إأآا]/g,"ا").replace(/ى/g,"ي").replace(/ة/g,"ه").replace(/ؤ/g,"و").replace(/ئ/g,"ي").replace(/[^؀-ۿa-z0-9\s]/gi," ").replace(/\s+/g," ").trim();}
function detectLang(m){return /[\u0600-\u06FF]/.test(m)?"ar":"en";}
function bestMatch(items,message,fields){const q=normalizeText(message);let best=null,score=0;const words=q.split(" ").filter(w=>w.length>=2);for(const it of items){let blob="";for(const f of fields) if(it[f]) blob+=" "+it[f];const t=normalizeText(blob);let s=0;for(const w of words) if(t.includes(w)) s+=2;if(q&&t.includes(q)) s+=4;if(s>score){score=s;best=it;}}return score>=2?best:null;}
function wireLogin(){const f=$("#loginForm");f.addEventListener("submit",async e=>{e.preventDefault();try{const u=await apiFetch("/login",{method:"POST",body:{email:f.email.value.trim(),password:f.password.value}});setSession(u);toast("Welcome",`Logged in as ${u.name}`);routeTo("#/");}catch{toast("Login failed","Check email/password.");}});}
function wireRegister(){const f=$("#registerForm");f.addEventListener("submit",async e=>{e.preventDefault();try{await apiFetch("/register",{method:"POST",body:{name:f.name.value.trim(),email:f.email.value.trim(),password:f.password.value}});toast("Account created","Now login.");routeTo("#/login");}catch(err){toast("Error",String(err.message).includes("EMAIL_EXISTS")?"Email exists":"Could not register.");}});}
async function wireInsurance(){const list=$("#insList"),qEl=$("#insQ"),cEl=$("#insCat");let items=[];async function load(){try{items=await apiFetch("/insurance");const cats=Array.from(new Set(items.map(x=>x.category_en||x.category_ar||""))).filter(Boolean).sort();cEl.innerHTML=`<option value="">All</option>`+cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");renderList();}catch(err){list.innerHTML=`<div class="card" style="background:rgba(255,255,255,.04);">API error: ${escapeHtml(err.message)}</div>`;}}function renderList(){const q=normalizeText(qEl.value),c=cEl.value;const filtered=items.filter(x=>{const blob=[x.title_ar,x.title_en,x.description_ar,x.description_en,x.category_ar,x.category_en].filter(Boolean).join(" ");const text=normalizeText(blob);return (!q||text.includes(q))&&(!c||(x.category_en||x.category_ar||"")===c);});list.innerHTML=filtered.length?filtered.map(x=>{const title=x.title_en||x.title_ar||"Insurance";const cat=x.category_en||x.category_ar||"";const desc=x.description_en||x.description_ar||"";return `<div class="card" style="background:rgba(255,255,255,.04);"><div class="row" style="justify-content:space-between;"><div style="font-weight:900;">${escapeHtml(title)}</div><span class="badge">${escapeHtml(cat)}</span></div><div class="small">Price from: <span class="code">${escapeHtml(x.price_from)}</span></div><p class="p" style="margin-top:8px;">${escapeHtml(desc)}</p></div>`;}).join(""):`<div class="card" style="background:rgba(255,255,255,.04);">No results.</div>`;}$("#insSearchBtn").addEventListener("click",renderList);$("#insResetBtn").addEventListener("click",()=>{qEl.value="";cEl.value="";renderList();});load();}
async function wireLaws(){const list=$("#lawList"),qEl=$("#lawQ");let items=[];async function load(){try{items=await apiFetch("/laws");renderList();}catch(err){list.innerHTML=`<div class="card" style="background:rgba(255,255,255,.04);">API error: ${escapeHtml(err.message)}</div>`;}}function renderList(){const q=normalizeText(qEl.value);const filtered=items.filter(x=>!q||normalizeText([x.title_ar,x.title_en,x.description_ar,x.description_en].filter(Boolean).join(" ")).includes(q));list.innerHTML=filtered.length?filtered.map(x=>`<div class="card" style="background:rgba(255,255,255,.04);"><div style="font-weight:900;">${escapeHtml(x.title_en||x.title_ar||"Law")}</div><p class="p" style="margin-top:8px;">${escapeHtml(x.description_en||x.description_ar||"")}</p></div>`).join(""):`<div class="card" style="background:rgba(255,255,255,.04);">No results.</div>`;}$("#lawSearchBtn").addEventListener("click",renderList);$("#lawResetBtn").addEventListener("click",()=>{qEl.value="";renderList();});load();}
async function wireFaq(){const list=$("#faqList"),qEl=$("#faqQ");let items=[];async function load(){try{items=await apiFetch("/faq");renderList();}catch(err){list.innerHTML=`<div class="card" style="background:rgba(255,255,255,.04);">API error: ${escapeHtml(err.message)}</div>`;}}function renderList(){const q=normalizeText(qEl.value);const filtered=items.filter(x=>!q||normalizeText([x.question_ar,x.question_en,x.answer_ar,x.answer_en].filter(Boolean).join(" ")).includes(q));list.innerHTML=filtered.length?filtered.map(x=>`<div class="card" style="background:rgba(255,255,255,.04);"><div style="font-weight:900;">Q: ${escapeHtml(x.question_en||x.question_ar||"Question")}</div><p class="p" style="margin-top:8px;">A: ${escapeHtml(x.answer_en||x.answer_ar||"Answer")}</p></div>`).join(""):`<div class="card" style="background:rgba(255,255,255,.04);">No results.</div>`;}$("#faqSearchBtn").addEventListener("click",renderList);$("#faqResetBtn").addEventListener("click",()=>{qEl.value="";renderList();});load();}
async function wireSubmit(){const s=getSession();if(!s)return;try{const items=await apiFetch("/insurance");$("#reqInsurance").innerHTML=`<option value="">—</option>`+items.map(i=>`<option value="${i.id}">${escapeHtml(i.title_en||i.title_ar||"Insurance")}</option>`).join("");}catch(err){toast("API error",err.message);}const f=$("#reqForm");f.addEventListener("submit",async e=>{e.preventDefault();try{await apiFetch("/requests",{method:"POST",body:{user_id:s.id,insurance_id:f.insuranceId.value?Number(f.insuranceId.value):null,full_name:f.fullName.value.trim(),phone:f.phone.value.trim(),car_model:f.carModel.value.trim(),car_year:Number(f.carYear.value),notes:f.notes.value.trim()||null}});toast("Submitted","Your request has been saved.");routeTo("#/my-requests");}catch{toast("Error","Could not submit request.");}});}
async function wireMyRequests(){const s=getSession();if(!s)return;const box=$("#myReqList");try{const rows=await apiFetch(`/requests/my/${s.id}`);box.innerHTML=rows.length?`<div class="grid">`+rows.map(r=>`<div class="card" style="background:rgba(255,255,255,.04);"><div class="row" style="justify-content:space-between;"><div style="font-weight:900;">#${r.id} • ${escapeHtml(r.title_en||r.title_ar||"—")}</div><span class="badge">${escapeHtml(r.status)}</span></div><div class="small">Car: <span class="code">${escapeHtml(r.car_model)} (${r.car_year})</span></div><div class="small">Phone: <span class="code">${escapeHtml(r.phone)}</span></div>${r.notes?`<div class="small">Notes: ${escapeHtml(r.notes)}</div>`:""}<div class="small">Submitted: ${new Date(r.created_at).toLocaleString()}</div></div>`).join("")+`</div>`:`<div class="card" style="background:rgba(255,255,255,.04);">No requests yet.</div>`;}catch(err){box.innerHTML=`<div class="card" style="background:rgba(255,255,255,.04);">API error: ${escapeHtml(err.message)}</div>`;}}
async function wireChatbot(){const log=$("#chatLog"),input=$("#chatMsg"),btn=$("#chatSend");let insurance=[],laws=[],faq=[];try{[insurance,laws,faq]=await Promise.all([apiFetch("/insurance"),apiFetch("/laws"),apiFetch("/faq")]);}catch{}function add(w,t,s){log.innerHTML+=`<div style="padding:10px 0;border-bottom:1px solid var(--line);"><div class="row" style="justify-content:space-between;"><span class="badge">${escapeHtml(w)}</span>${s?`<span class="badge">${escapeHtml(s)}</span>`:""}</div><div style="margin-top:6px;white-space:pre-wrap;">${escapeHtml(t)}</div></div>`;log.scrollTop=log.scrollHeight;}function replyInsuranceInfo(ins,lang){const title=lang==="ar"?(ins.title_ar||ins.title_en):(ins.title_en||ins.title_ar);const desc=lang==="ar"?(ins.description_ar||ins.description_en):(ins.description_en||ins.description_ar);const cat=lang==="ar"?(ins.category_ar||ins.category_en):(ins.category_en||ins.category_ar);const line2=lang==="ar"?`الفئة: ${cat||""}`:`Category: ${cat||""}`;const line3=lang==="ar"?`السعر يبدأ من: ${ins.price_from}`:`Price from: ${ins.price_from}`;return `${title}\n${line2}\n${line3}\n${desc||""}`.trim();}function chatbotSearch(msg){const lang=detectLang(msg);const q=normalizeText(msg);const priceKeys=lang==="ar"?["سعر","كم","تكلف","اسعار","ثمن"]:["price","cost","how much","pricing","fee"];if(priceKeys.some(k=>q.includes(normalizeText(k)))){const hit=bestMatch(insurance,msg,["title_ar","title_en","description_ar","description_en","category_ar","category_en"]);if(hit)return{reply:replyInsuranceInfo(hit,lang),source:"Insurance"};}const submitKeys=lang==="ar"?["طلب","تقديم","ارسال","استماره","نموذج"]:["submit","request","apply","form"];if(submitKeys.some(k=>q.includes(normalizeText(k)))){if(!getSession())return{reply:lang==="ar"?"لازم تعمل تسجيل دخول أولاً.":"You need to login first.",source:"System"};return{reply:lang==="ar"?"روح على Submit Request وعبّي البيانات وبعدين Submit.":"Go to Submit Request, fill details, then Submit.",source:"System"};}const faqHit=bestMatch(faq,msg,["question_ar","question_en","answer_ar","answer_en"]);if(faqHit){const ans=lang==="ar"?(faqHit.answer_ar||faqHit.answer_en):(faqHit.answer_en||faqHit.answer_ar);return{reply:ans|| (lang==="ar"?"ما لقيت جواب.":"No answer found."),source:"FAQ"};}const lawHit=bestMatch(laws,msg,["title_ar","title_en","description_ar","description_en"]);if(lawHit){const txt=lang==="ar"?(lawHit.description_ar||lawHit.description_en):(lawHit.description_en||lawHit.description_ar);return{reply:txt|| (lang==="ar"?"ما لقيت قانون.":"No law found."),source:"Law"};}const insHit=bestMatch(insurance,msg,["title_ar","title_en","description_ar","description_en","category_ar","category_en"]);if(insHit)return{reply:replyInsuranceInfo(insHit,lang),source:"Insurance"};return{reply:lang==="ar"?"ما لقيت جواب مباشر. جرّب تسأل عن التأمين/القوانين/FAQ.":"No direct match. Try insurance/laws/FAQ.",source:"Fallback"};}function send(){const m=input.value.trim();if(!m)return;input.value="";add("you",m);const r=chatbotSearch(m);add("bot",r.reply,r.source);}btn.addEventListener("click",send);input.addEventListener("keydown",e=>{if(e.key==="Enter")send();});add("bot","Hi! Ask about insurance, laws, FAQ, requests.\nمرحباً! اسأل عن التأمين والقوانين وFAQ والطلبات.","System");}
async function wireAdmin(){const s=getSession();if(!s||s.role!=="ADMIN")return;$("#addIns").addEventListener("submit",async e=>{e.preventDefault();const f=e.target;try{await apiFetch("/admin/insurance",{method:"POST",body:{title_ar:f.title_ar.value.trim(),title_en:f.title_en.value.trim(),category_ar:f.category_ar.value.trim(),category_en:f.category_en.value.trim(),price_from:Number(f.price_from.value),description_ar:f.description_ar.value.trim(),description_en:f.description_en.value.trim()}});toast("Added","Insurance added.");f.reset();}catch{toast("Error","Admin action failed.");}});$("#addLaw").addEventListener("submit",async e=>{e.preventDefault();const f=e.target;try{await apiFetch("/admin/laws",{method:"POST",body:{title_ar:f.title_ar.value.trim(),title_en:f.title_en.value.trim(),description_ar:f.description_ar.value.trim(),description_en:f.description_en.value.trim()}});toast("Added","Law added.");f.reset();}catch{toast("Error","Admin action failed.");}});$("#addFaq").addEventListener("submit",async e=>{e.preventDefault();const f=e.target;try{await apiFetch("/admin/faq",{method:"POST",body:{question_ar:f.question_ar.value.trim(),question_en:f.question_en.value.trim(),answer_ar:f.answer_ar.value.trim(),answer_en:f.answer_en.value.trim()}});toast("Added","FAQ added.");f.reset();}catch{toast("Error","Admin action failed.");}});renderAdminUsers();renderAdminRequests();}
async function renderAdminUsers(){const box=$("#adminUsersList");if(!box)return;try{const users=await apiFetch("/admin/users");const session=getSession();box.innerHTML=users.map(u=>`<div class="card" style="background:rgba(255,255,255,.04); margin-bottom:10px;"><div class="row" style="justify-content:space-between;"><div style="font-weight:900;">${escapeHtml(u.name)} • ${escapeHtml(u.email)}</div><span class="badge">${u.role==="ADMIN"?"Administrator":"User"}</span></div><div class="row" style="margin-top:10px;"><button class="btn btn-ghost" data-role="${u.id}:USER" ${session&&u.id===session.id?"disabled":""}>Make User</button><button class="btn" data-role="${u.id}:ADMIN" ${session&&u.id===session.id?"disabled":""}>Make Admin</button></div>${session&&u.id===session.id?`<div class="small" style="margin-top:8px;">You can’t change your own role.</div>`:""}</div>`).join("");$$("[data-role]").forEach(btn=>{btn.addEventListener("click",async ()=>{const [idStr,role]=btn.getAttribute("data-role").split(":");try{await apiFetch(`/admin/users/${Number(idStr)}/role`,{method:"PATCH",body:{role}});toast("Updated",`User → ${role}`);await renderAdminUsers();}catch{toast("Error","Could not update role.");}});});}catch(err){box.innerHTML=`<div class="card" style="background:rgba(255,255,255,.04);">API error: ${escapeHtml(err.message)}</div>`;}}
async function renderAdminRequests(){const box=$("#adminReqList");if(!box)return;try{const reqs=await apiFetch("/admin/requests");if(!reqs.length){box.innerHTML=`<div class="card" style="background:rgba(255,255,255,.04);">No requests yet.</div>`;return;}box.innerHTML=reqs.map(r=>`<div class="card" style="background:rgba(255,255,255,.04); margin-bottom:10px;"><div class="row" style="justify-content:space-between;"><div style="font-weight:900;">#${r.id} • ${escapeHtml(r.user_name)} (${escapeHtml(r.user_email)})</div><span class="badge">${escapeHtml(r.status)}</span></div><div class="small" style="margin-top:8px;">Insurance: <span class="code">${escapeHtml(r.ins_title_en||r.ins_title_ar||"—")}</span></div><div class="small">Car: <span class="code">${escapeHtml(r.car_model)} (${r.car_year})</span></div><div class="small">Phone: <span class="code">${escapeHtml(r.phone)}</span></div>${r.notes?`<div class="small">Notes: ${escapeHtml(r.notes)}</div>`:""}<div class="row" style="margin-top:10px;"><button class="btn btn-ghost" data-setstatus="${r.id}:REVIEWING">Reviewing</button><button class="btn" data-setstatus="${r.id}:APPROVED">Approve</button><button class="btn btn-ghost" data-setstatus="${r.id}:REJECTED">Reject</button></div></div>`).join("");$$("[data-setstatus]").forEach(btn=>{btn.addEventListener("click",async ()=>{const [idStr,status]=btn.getAttribute("data-setstatus").split(":");try{await apiFetch(`/admin/requests/${Number(idStr)}/status`,{method:"PATCH",body:{status}});toast("Updated",`#${idStr} → ${status}`);await renderAdminRequests();}catch{toast("Error","Could not update status.");}});});}catch(err){box.innerHTML=`<div class="card" style="background:rgba(255,255,255,.04);">API error: ${escapeHtml(err.message)}</div>`;}}
